<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Licenças Corporativas</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f7fafc;
      color: #2d3748;
      display: flex;
      min-height: 100vh;
    }
    aside {
      width: 80px;
      background-color: #2b6cb0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 1.5rem 0;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }
    .sidebar-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: #edf2f7;
      text-align: center;
      font-size: 0.75rem;
      line-height: 1.2;
      transition: color 0.2s ease;
    }
    .sidebar-link:hover {
      color: #fff;
    }
    .sidebar-link svg {
      margin-bottom: 0.5rem;
    }
    .content-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    header {
      background-color: #fff;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1a202c;
    }
    main {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }
    .section-spacing {
      margin-bottom: 2rem;
    }
    .grid-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    @media (min-width: 768px) {
      .grid-container-md {
        grid-template-columns: repeat(3, 1fr);
      }
      .col-span-2-md {
        grid-column: span 2;
      }
    }
    @media (min-width: 1024px) {
      .grid-container-lg {
        grid-template-columns: 2fr 1fr;
      }
    }
    .card {
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
    }
    .label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #4a5568;
      margin-bottom: 0.5rem;
    }
    .file-input {
      width: 100%;
      font-size: 0.875rem;
      color: #4a5568;
    }
    .file-input::-webkit-file-upload-button {
      background-color: #e2e8f0;
      color: #2b6cb0;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .file-input::-webkit-file-upload-button:hover {
      background-color: #cbd5e0;
    }
    .checkbox-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      color: #4a5568;
    }
    .checkbox {
      height: 1.25rem;
      width: 1.25rem;
      border: 2px solid #e2e8f0;
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }
    .checkbox:checked {
      background-color: #2b6cb0;
      border-color: #2b6cb0;
    }
    .checkbox-text {
      margin-left: 0.5rem;
    }
    .button {
      width: 100%;
      padding: 0.75rem;
      border-radius: 6px;
      color: #fff;
      font-size: 0.875rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .button-gray {
      background-color: #718096;
    }
    .button-gray:hover {
      background-color: #5a667a;
    }
    .button-blue {
      background-color: #2b6cb0;
    }
    .button-blue:hover {
      background-color: #2c5282;
    }
    .button-red {
      background-color: #e53e3e;
    }
    .button-red:hover {
      background-color: #c53030;
    }
    .table-container {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    .table-header {
      background-color: #edf2f7;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    th {
      font-weight: 600;
      color: #4a5568;
    }
    tbody tr:nth-child(even) {
      background-color: #f7fafc;
    }
    tbody tr:hover {
      background-color: #edf2f7;
    }
    .search-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.875rem;
      transition: border-color 0.2s ease;
    }
    .search-input:focus {
      border-color: #2b6cb0;
      outline: none;
    }
    .both-licenses {
      background-color: #bee3f8 !important;
    }
    .alert-badge {
      padding: 0.75rem;
      border-radius: 6px;
      background-color: #fff5f5;
      color: #e53e3e;
      font-size: 0.875rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .alert-details {
      display: none;
      margin-top: 0.75rem;
      padding-left: 1.5rem;
      font-size: 0.875rem;
      color: #4a5568;
    }
    .alert-details.show {
      display: block;
    }
    .conflict {
      background-color: #fefcbf !important;
    }
    .dup-license {
      background-color: #fed7d7 !important;
    }
    .multi-search-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .multi-search-row select, .multi-search-row input {
      padding: 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    .multi-search-row button {
      padding: 0.5rem;
      background-color: #e2e8f0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .multi-search-row button:hover {
      background-color: #cbd5e0;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside>
    <a href="https://github.com/pedr-moura" target="_blank" class="sidebar-link">
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 16 16">
        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8"/>
      </svg>
      Pedro Moura<br>2025
    </a>
  </aside>

  <!-- Content -->
  <div class="content-container">
    <!-- Header -->
    <header>
      <h1>Gestão de Licenças</h1>
    </header>

    <main>
      <!-- Upload & Columns Toggle -->
      <div class="grid-container grid-container-md section-spacing">
        <div class="card">
          <label for="jsonFile" class="label">Carregar JSON</label>
          <input id="jsonFile" type="file" accept=".json" class="file-input" />
        </div>
        <div class="card col-span-2-md">
          <span class="label">Colunas Visíveis</span>
          <div class="checkbox-container" id="colContainer">
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="0" /><span class="checkbox-text">ID</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="1" checked /><span class="checkbox-text">Nome</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="2" checked /><span class="checkbox-text">Email</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="3" checked /><span class="checkbox-text">Cargo</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="4" /><span class="checkbox-text">Unidade</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="5" /><span class="checkbox-text">Telefones</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="6" /><span class="checkbox-text">Licenças</span></label>
          </div>
        </div>
      </div>

      <!-- Multi-Search & Alerts -->
      <div class="grid-container grid-container-lg section-spacing">
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="font-size: 1.125rem; font-weight: 600; color: #4a5568;">Pesquisa Múltipla</h2>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <label style="font-size: 0.875rem; color: #4a5568;">Comparação:</label>
              <select id="multiSearchOperator" class="search-input">
                <option value="AND" selected>E</option>
                <option value="OR">OU</option>
              </select>
              <button id="addSearchField" class="button button-blue">Adicionar Filtro</button>
            </div>
          </div>
          <div id="multiSearchFields"></div>
          <div id="searchCriteria" style="font-size: 0.875rem; color: #4a5568; margin-top: 0.75rem;"></div>
          <div id="alertPanel" style="margin-top: 0.75rem;"></div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <button id="clearFilters" class="button button-gray">Limpar Filtros</button>
          <button id="exportCsv" class="button button-blue">Exportar CSV</button>
          <button id="exportIssues" class="button button-red">Relatório de Falhas</button>
        </div>
      </div>

      <!-- DataTable -->
      <div class="card">
        <table id="licenseTable" class="table-container">
          <thead class="table-header">
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>Email</th>
              <th>Cargo</th>
              <th>Unidade</th>
              <th>Telefones</th>
              <th>Licenças</th>
            </tr>
            <tr>
              <th><input class="search-input" placeholder="Busca ID" /></th>
              <th><input class="search-input" placeholder="Busca Nome" /></th>
              <th><input class="search-input" placeholder="Busca Email" /></th>
              <th><input class="search-input" placeholder="Busca Cargo" /></th>
              <th><input class="search-input" placeholder="Busca Unidade" /></th>
              <th><input class="search-input" placeholder="Busca Telefones" /></th>
              <th><input class="search-input" placeholder="Busca Licenças" /></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
  $(document).ready(function() {
    let table = null, allData = [], nameConflicts = new Set(), dupLicUsers = new Set();

    const nameKey = u => `${u.DisplayName || ''}|||${u.OfficeLocation || ''}`;
    const escapeHtml = s => typeof s === 'string' ? s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&apos;' })[m]) : '';

    function validateJson(data) {
      if (!Array.isArray(data)) {
        alert('JSON inválido: Deve ser um array de objetos.');
        return [];
      }
      return data.map((u, i) => u && typeof u === 'object' ? {
        Id: u.Id || `unknown_${i}`,
        DisplayName: u.DisplayName || 'Desconhecido',
        OfficeLocation: u.OfficeLocation || 'Desconhecido',
        Email: u.Email || '',
        JobTitle: u.JobTitle || '',
        BusinessPhones: Array.isArray(u.BusinessPhones) ? u.BusinessPhones : [],
        Licenses: Array.isArray(u.Licenses) ? u.Licenses.map(l => ({
          LicenseName: l.LicenseName || `Lic_${i}_${Math.random().toString(36).substr(2, 5)}`,
          SkuId: l.SkuId || ''
        })) : []
      } : null).filter(x => x);
    }

    function findIssues(data) {
      const nameMap = new Map(), dupSet = new Set(), officeLic = new Set([
        'Microsoft 365 E3', 'Microsoft 365 E5',
        'Microsoft 365 Business Standard', 'Microsoft 365 Business Premium',
        'Office 365 E3', 'Office 365 E5'
      ]);
      data.forEach(u => {
        const k = nameKey(u);
        nameMap.set(k, (nameMap.get(k) || 0) + 1);
        const cnt = new Map();
        u.Licenses.forEach(l => {
          const base = l.LicenseName.match(/^(Microsoft 365|Office 365)/)?.[0] || l.LicenseName;
          cnt.set(base, (cnt.get(base) || 0) + 1);
        });
        if ([...cnt].some(([lic, c]) => officeLic.has(lic) && c > 1)) dupSet.add(u.Id);
      });
      return { nameConflicts: new Set([...nameMap].filter(([, c]) => c > 1).map(([k]) => k)), dupLicUsers: dupSet };
    }

    function renderAlerts() {
      const $p = $('#alertPanel').empty();
      if (nameConflicts.size) {
        $p.append(`<div class="alert-badge">
          <button id="filterNameConflicts" style="
    background: none;
    border: none;
    color: gray;
" class="underline">⚠️ Conflitos Nome+Unidade: ${nameConflicts.size}</button>
        </div>`);
      }
      if (dupLicUsers.size) {
        const list = allData.filter(u => dupLicUsers.has(u.Id)).map(u => {
          const cnt = {}, dups = [];
          u.Licenses.forEach(l => cnt[l.LicenseName] = (cnt[l.LicenseName] || 0) + 1);
          Object.entries(cnt).forEach(([lic, c]) => c > 1 && dups.push(lic));
          const hasPaid = u.Licenses.some(l => !l.LicenseName.toLowerCase().includes('free'));
          return `<li>${escapeHtml(u.DisplayName)} (${escapeHtml(u.OfficeLocation)}): ${escapeHtml(dups.join(', '))} — Paga: ${hasPaid ? 'Sim' : 'Não'}</li>`;
        }).join('');
        $p.append(`<div class="alert-badge">
          ⚠️ Licenças duplicadas: ${dupLicUsers.size}
          <button class="underline toggle-details" data-target="dupDetails">Detalhes</button>
        </div>
        <div id="dupDetails" class="alert-details"><ul>${list}</ul></div>`);
      }
      $('#filterNameConflicts').off('click').on('click', () => {
        const ids = allData.filter(u => nameConflicts.has(nameKey(u))).map(u => u.Id);
        table.columns().search('').draw();
        table.column(0).search(ids.join('|'), true, false).draw();
      });
      $('.toggle-details').off('click').on('click', function () {
        const tgt = $(this).data('target');
        $(`#${tgt}`).toggleClass('show');
        $(this).text($(`#${tgt}`).hasClass('show') ? 'Ocultar' : 'Detalhes');
      });
    }

    function initTable(data) {
      allData = data;
      ({ nameConflicts, dupLicUsers } = findIssues(allData));
      if (table) table.destroy();
      table = $('#licenseTable').DataTable({
        data: allData,
        deferRender: true,
        pageLength: 25,
        orderCellsTop: true,
        responsive: true,
        stateSave: true,
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
        },
        columnDefs: [
          { targets: '_all', visible: false },
          { targets: [1, 2, 3], visible: true }
        ],
        columns: [
          { data: 'Id' },
          { data: 'DisplayName' },
          { data: 'Email' },
          { data: 'JobTitle' },
          { data: 'OfficeLocation' },
          { data: 'BusinessPhones', render: p => Array.isArray(p) ? p.join('; ') : p },
          { data: 'Licenses', render: l => Array.isArray(l) ? l.map(x => x.LicenseName).join(', ') : '' }
        ],
        initComplete: function () {
          const api = this.api();
          api.columns().every(function (i) {
            $('input', this.header()).on('keyup change clear', function () {
              api.column(i).search(this.value).draw();
            });
          });
          $('#colContainer .col-vis').each(function () {
            const idx = +$(this).data('col');
            $(this).prop('checked', api.column(idx).visible());
          });
          $('.col-vis').off('change').on('change', function () {
            const col = api.column($(this).data('col'));
            col.visible(!col.visible());
          });
        },
        rowCallback: function (r, u) {
          if (nameConflicts.has(nameKey(u))) $(r).addClass('conflict');
          if (dupLicUsers.has(u.Id)) $(r).addClass('dup-license');
          const licenses = u.Licenses.map(l => l.LicenseName);
          const searchLicenses = $('#multiSearchFields .multi-search-row')
            .filter(function () { return $(this).find('.column-select').val() == 6; })
            .find('.search-input').map(function () { return $(this).val().trim(); }).get();
          if (searchLicenses.length > 1 && $('#multiSearchOperator').val() === 'AND' && searchLicenses.every(lic => licenses.includes(lic))) {
            $(r).addClass('both-licenses');
          }
        },
        drawCallback: renderAlerts
      });
    }

    function setupMultiSearch() {
      const cols = [
        { v: 0, text: 'ID' },
        { v: 1, text: 'Nome' },
        { v: 2, text: 'Email' },
        { v: 3, text: 'Cargo' },
        { v: 4, text: 'Unidade' },
        { v: 5, text: 'Telefones' },
        { v: 6, text: 'Licenças' }
      ];
      const $ct = $('#multiSearchFields').empty();
      function addSearchField() {
        const $r = $(`<div class="multi-search-row">
          <select class="column-select">
            ${cols.map(c => `<option value="${c.v}">${c.text}</option>`).join('')}
          </select>
          <input class="search-input" placeholder="Termo..." />
          <button class="remove-field">✕</button>
        </div>`);
        $ct.append($r);
        $r.find('.search-input').on('keyup change', applyMultiSearch);
        $r.find('.column-select').on('change', applyMultiSearch);
        $r.find('.remove-field').on('click', () => { $r.remove(); applyMultiSearch(); });
      }
      $('#addSearchField').off('click').on('click', addSearchField);
      addSearchField(); // Inicializa com um campo
    }

    function applyMultiSearch() {
      const op = $('#multiSearchOperator').val();
      $('#searchCriteria').text(op === 'AND' 
        ? 'Critério: Afunilando resultados (todos os filtros devem corresponder)' 
        : 'Critério: Expandindo resultados (qualquer filtro corresponde)');
      if (!table) return;

      table.search('').columns().search('').draw();

      const rows = $('#multiSearchFields .multi-search-row');
      if (rows.length === 0) return;

      const filters = [];
      rows.each(function () {
        const idx = $(this).find('.column-select').val();
        const val = $(this).find('.search-input').val().trim();
        if (val) filters.push({ col: idx, term: val });
      });

      $.fn.dataTable.ext.search.push(
        function (settings, data, dataIndex) {
          const rowData = table.row(dataIndex).data();
          if (op === 'OR') {
            return filters.some(filter => {
              if (filter.col == 6) {
                const licenses = rowData.Licenses.map(l => l.LicenseName).join(', ');
                return licenses.toLowerCase().includes(filter.term.toLowerCase());
              } else {
                const cellValue = data[filter.col] || '';
                return cellValue.toLowerCase().includes(filter.term.toLowerCase());
              }
            });
          } else {
            return filters.every(filter => {
              if (filter.col == 6) {
                const licenses = rowData.Licenses.map(l => l.LicenseName).join(', ');
                return licenses.toLowerCase().includes(filter.term.toLowerCase());
              } else {
                const cellValue = data[filter.col] || '';
                return cellValue.toLowerCase().includes(filter.term.toLowerCase());
              }
            });
          }
        }
      );

      table.draw();
      $.fn.dataTable.ext.search.pop();
    }

    $('#clearFilters').on('click', () => {
      if (!table) return;
      $('#licenseTable thead input').val('');
      table.search('').columns().search('').draw();
      $('#multiSearchFields').empty();
      setupMultiSearch();
      $('#alertPanel').empty();
      $('#colContainer .col-vis').each(function () {
        const idx = +$(this).data('col'),
          vis = [1, 2, 3].includes(idx);
        table.column(idx).visible(vis);
        $(this).prop('checked', vis);
      });
      table.draw();
    });

    function escapeCsv(v) {
      if (v == null) return '';
      const s = String(v);
      return (/[,"\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s);
    }
    function downloadCsv(csv, fn) {
      const b = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(b);
      a.download = fn;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    $('#exportCsv').on('click', () => {
      if (!table) return alert('Tabela não iniciada');
      const data = table.rows({ filter: 'applied' }).data().toArray();
      if (!data.length) return alert('Nenhum registro filtrado.');
      const hdr = ['Id', 'Nome', 'Email', 'Cargo', 'Unidade', 'Telefones', 'Licenças'];
      const rows = data.map(u => [
        u.Id, u.DisplayName, u.Email, u.JobTitle, u.OfficeLocation,
        Array.isArray(u.BusinessPhones) ? u.BusinessPhones.join('; ') : u.BusinessPhones || '',
        Array.isArray(u.Licenses) ? u.Licenses.map(x => x.LicenseName).join(', ') : ''
      ]);
      downloadCsv([hdr, ...rows].map(r => r.map(escapeCsv).join(',')).join('\n'), 'relatorio.csv');
    });

    $('#exportIssues').on('click', () => {
      if (!table) return alert('Tabela não iniciada');
      let lines = [];
      if (nameConflicts.size) {
        lines.push(['CONFLITOS Nome+Unidade'], ['Nome', 'Unidade']);
        nameConflicts.forEach(k => lines.push(k.split('|||')));
        lines.push([]);
      }
      if (dupLicUsers.size) {
        lines.push(['USUÁRIOS com Licenças Duplicadas'], ['Nome', 'Unidade', 'Duplicatas', 'Paga']);
        allData.filter(u => dupLicUsers.has(u.Id)).forEach(u => {
          const cnt = {}, dups = [];
          u.Licenses.forEach(l => cnt[l.LicenseName] = (cnt[l.LicenseName] || 0) + 1);
          Object.entries(cnt).forEach(([l, c]) => c > 1 && dups.push(l));
          const hasPaid = u.Licenses.some(l => !l.LicenseName.toLowerCase().includes('free'));
          lines.push([u.DisplayName, u.OfficeLocation, dups.join('; '), hasPaid ? 'Sim' : 'Não']);
        });
      }
      if (!lines.length) return alert('Nenhuma falha detectada.');
      downloadCsv(lines.map(r => r.map(escapeCsv).join(',')).join('\n'), 'relatorio_falhas.csv');
    });

    $('#jsonFile').on('change', e => {
      const f = e.target.files[0];
      if (!f) return;
      const fr = new FileReader();
      fr.onload = () => {
        try {
          const d = JSON.parse(fr.result);
          const v = validateJson(d);
          if (!v.length) {
            alert('Nenhum usuário válido encontrado no JSON.');
            return;
          }
          initTable(v);
          setupMultiSearch();
        } catch (er) {
          alert('Erro ao processar JSON: ' + er.message);
        }
      };
      fr.readAsText(f);
    });
  });
  </script>
</body>
</html>
