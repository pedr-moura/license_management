<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Licenças Corporativas</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #1a202c;
      color: #e2e8f0;
      display: flex;
      min-height: 100vh;
    }
    aside {
      width: 80px;
      background-color: #2d3748;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 1.5rem 0;
      border-right: 1px solid #4a5568;
    }
    .sidebar-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.75rem 0;
      text-decoration: none;
      color: #cbd5e0;
      text-align: center;
      font-size: 0.75rem;
      line-height: 1.2;
      transition: color 0.2s ease, background-color 0.2s ease;
    }
    .sidebar-link:hover {
      color: #ffffff;
      background-color: #4a5568;
    }
    .sidebar-link svg {
      margin-bottom: 0.5rem;
      fill: currentColor;
    }
    .content-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    header {
      background-color: #2d3748;
      padding: 1rem 2rem;
      border-bottom: 1px solid #4a5568;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #ffffff;
    }
    main {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      width: 90dvw;
    }
    .section-spacing {
      margin-bottom: 2rem;
    }
    .grid-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    @media (min-width: 768px) {
      .grid-container-md {
        grid-template-columns: repeat(3, 1fr);
      }
      .col-span-2-md {
        grid-column: span 2;
      }
    }
    @media (min-width: 1024px) {
      .grid-container-lg {
        grid-template-columns: 2fr 1fr;
      }
    }
    .card {
      background-color: #2d3748;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #4a5568;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      border-color: #5a667a;
    }
    .label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #a0aec0;
      margin-bottom: 0.5rem;
    }
    .file-input {
      width: 100%;
      font-size: 0.875rem;
      color: #a0aec0;
      padding: 0.5rem;
      border: 1px solid #4a5568;
      border-radius: 6px;
      background-color: #1a202c;
    }
    .file-input::-webkit-file-upload-button {
      background-color: #4a5568;
      color: #e2e8f0;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .file-input::-webkit-file-upload-button:hover {
      background-color: #5a667a;
    }
    .checkbox-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      color: #a0aec0;
    }
    .checkbox {
      height: 1.25rem;
      width: 1.25rem;
      border: 2px solid #4a5568;
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s ease, background-color 0.2s ease;
      appearance: none;
      background-color: transparent;
      position: relative;
    }
    .checkbox:checked {
      background-color: #3b82f6;
      border-color: #3b82f6;
    }
    .checkbox:checked::before {
      content: '✔';
      font-size: 0.8rem;
      color: #ffffff;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .checkbox-text {
      margin-left: 0.5rem;
    }
    .button {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      color: #ffffff;
      font-size: 0.875rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .button i {
      font-size: 0.9em;
    }
    .button-gray {
      background-color: #4a5568;
    }
    .button-gray:hover {
      background-color: #5a667a;
    }
    .button-blue {
      background-color: #3b82f6;
    }
    .button-blue:hover {
      background-color: #2563eb;
    }
    .button-red {
      background-color: #ef4444;
    }
    .button-red:hover {
      background-color: #dc2626;
    }
    /* Estilos da Tabela */
    .table-container {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
      background-color: #2d3748;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid #4a5568;
      color: #cbd5e0;
    }
    th {
      background-color: #2d3748;
      font-weight: 600;
      color: #e2e8f0;
    }
    tbody tr {
      background-color: #2d3748;
      transition: background-color 0.15s ease;
    }
    tbody tr:nth-child(even) {
      background-color: #262f40;
    }
    tbody tr:hover {
      background-color: #4a5568;
    }
    /* Inputs de busca no cabeçalho */
    .search-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #4a5568;
      border-radius: 6px;
      font-size: 0.875rem;
      background-color: #1a202c;
      color: #e2e8f0;
      transition: border-color 0.2s ease, background-color 0.2s ease;
    }
    .search-input:focus {
      border-color: #3b82f6;
      outline: none;
      background-color: #222938;
    }
    .search-input::placeholder {
      color: #718096;
    }
    /* Estilos para Controles do DataTables */
    .dataTables_wrapper {
      color: #a0aec0;
      margin-top: 1rem;
    }
    .dataTables_length {
      margin-bottom: 1rem;
    }
    .dataTables_length label {
      font-size: 0.875rem;
      color: #a0aec0;
    }
    .dataTables_length select {
      background-color: #1a202c;
      color: #e2e8f0;
      border: 1px solid #4a5568;
      padding: 0.35rem 0.5rem;
      border-radius: 4px;
      margin: 0 0.5rem;
    }
    .dataTables_filter {
      margin-bottom: 1rem;
    }
    .dataTables_filter label {
      font-size: 0.875rem;
      color: #a0aec0;
    }
    .dataTables_filter input {
      background-color: #1a202c;
      color: #e2e8f0;
      border: 1px solid #4a5568;
      padding: 0.35rem 0.5rem;
      border-radius: 4px;
      width: 200px;
    }
    .dataTables_info {
      font-size: 0.875rem;
      color: #a0aec0;
      padding-top: 0.5rem;
    }
    .dataTables_paginate {
      margin-top: 1rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.25rem;
    }
    .dataTables_paginate .paginate_button {
      color: #a0aec0 !important;
      border: 1px solid #4a5568;
      background: #2d3748;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      text-decoration: none;
    }
    .dataTables_paginate .paginate_button:hover {
      background: #4a5568;
      border-color: #5a667a;
      color: #ffffff !important;
    }
    .dataTables_paginate .paginate_button.current,
    .dataTables_paginate .paginate_button.current:hover {
      background: #3b82f6;
      border-color: #3b82f6;
      color: #ffffff !important;
    }
    .dataTables_paginate .paginate_button.disabled,
    .dataTables_paginate .paginate_button.disabled:hover {
      background: #2d3748;
      border-color: #4a5568;
      color: #718096 !important;
      cursor: not-allowed;
     cursor: default;
    }
    /* Estilos para Pesquisa Avançada */
    .multi-search-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      align-items: center;
    }
    .multi-search-row .column-select {
      flex: 0 0 150px;
    }
    .multi-search-row .search-input {
      flex-grow: 1;
    }
    .multi-search-row .remove-field {
      padding: 0.5rem 0.75rem;
      background-color: #4a5568;
      color: #e2e8f0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      flex-shrink: 0;
      font-size: 1rem;
      line-height: 1;
    }
    .multi-search-row .remove-field:hover {
      background-color: #ef4444;
      color: #ffffff;
    }
    #searchCriteria {
      font-size: 0.875rem;
      color: #a0aec0;
      margin-top: 1rem;
      padding: 0.5rem;
      background-color: #222938;
      border-radius: 4px;
      border: 1px solid #4a5568;
      min-height: 1.5em;
    }
    .multi-search-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .multi-search-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #e2e8f0;
    }
    .multi-search-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .multi-search-controls label {
      font-size: 0.875rem;
      color: #a0aec0;
    }
    .multi-search-controls #multiSearchOperator {
      width: auto;
      padding: 0.5rem 2em 0.5rem 0.75rem;
    }
    .multi-search-controls #addSearchField {
      padding: 0.5rem 1rem;
      width: auto;
      gap: 0.3rem;
    }
    .multi-search-controls #addSearchField i {
      font-size: 0.8em;
    }
    /* Estilos para Linhas Destacadas */
    .conflict {
      background-color: rgba(234, 179, 8, 0.10) !important;
      border-left: 3px solid #D97706;
    }
    .conflict td {
      color: #FCD34D !important;
    }
    .dup-license {
      background-color: rgba(220, 38, 38, 0.10) !important;
      border-left: 3px solid #B91C1C;
    }
    .dup-license td {
      color: #FECACA !important;
    }
    /* Estilos para Alertas */
    .alert-badge {
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      background-color: rgba(239, 68, 68, 0.1);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .alert-badge button.underline {
      color: #fca5a5;
      text-decoration-color: #fca5a5;
    }
    .alert-badge button.underline:hover {
      color: #ffffff;
      text-decoration-color: #ffffff;
    }
    .alert-details {
      display: none;
      margin-top: 0.75rem;
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      color: #a0aec0;
      background-color: #1a202c;
      border-radius: 4px;
      border: 1px solid #4a5568;
    }
    .alert-details.show {
      display: block;
    }
    .alert-details ul {
      padding-left: 1.25rem;
      list-style-type: disc;
    }
    .alert-details li {
      margin-bottom: 0.25rem;
    }
    /* Estilo para Selects */
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23A0AEC0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-13z%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: right 0.7em top 50%;
      background-size: 0.65em auto;
      padding-right: 2.5em;
      background-color: #1a202c;
      color: #e2e8f0;
      border: 1px solid #4a5568;
      border-radius: 4px;
    height: 33px;
    min-width: 60px;
    padding: 0px 10px;
    }
    select:focus {
      border-color: #3b82f6;
      outline: none;
    }
    /* Responsividade para Tabela */
    @media (max-width: 768px) {
      .table-container {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      .dataTables_paginate {
        justify-content: center;
      }
      .dataTables_filter,
      .dataTables_length {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <aside>
    <a href="https://github.com/pedr-moura" target="_blank" class="sidebar-link">
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 16 16">
        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8"/>
      </svg>
      <span>Pedro Moura<br>2025</span>
    </a>
  </aside>

  <div class="content-container">
    <header>
      <h1><i class="fas fa-id-card-alt" style="margin-right: 0.5rem;"></i>Gestão de Licenças</h1>
    </header>

    <main>
      <div class="grid-container grid-container-md section-spacing">
        <div class="card">
          <label for="jsonFile" class="label">Carregar Arquivo JSON</label>
          <input id="jsonFile" type="file" accept=".json" class="file-input" />
        </div>
        <div class="card col-span-2-md">
          <span class="label">Colunas Visíveis na Tabela</span>
          <div class="checkbox-container" id="colContainer">
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="0" /><span class="checkbox-text">ID</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="1" checked /><span class="checkbox-text">Nome</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="2" checked /><span class="checkbox-text">Email</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="3" checked /><span class="checkbox-text">Cargo</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="4" /><span class="checkbox-text">Unidade</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="5" /><span class="checkbox-text">Telefones</span></label>
            <label class="checkbox-label"><input type="checkbox" class="checkbox col-vis" data-col="6" checked /><span class="checkbox-text">Licenças</span></label>
          </div>
        </div>
      </div>

      <div class="grid-container grid-container-lg section-spacing">
        <div class="card">
          <div class="multi-search-header">
            <h2><i class="fas fa-filter" style="margin-right: 0.5rem;"></i>Pesquisa Avançada</h2>
            <div class="multi-search-controls">
              <label for="multiSearchOperator">Operador:</label>
              <select id="multiSearchOperator">
                <option value="AND" selected>E (Todos)</option>
                <option value="OR">OU (Qualquer)</option>
              </select>
              <button id="addSearchField" class="button button-blue"><i class="fas fa-plus"></i> Filtro</button>
            </div>
          </div>
          <div id="multiSearchFields"></div>
          <div id="searchCriteria">Critério de pesquisa será exibido aqui...</div>
          <div id="alertPanel" style="margin-top: 1rem;"></div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div class="card" style="padding: 1rem;"> <h3 class="label" style="margin-bottom: 1rem; font-size: 1rem;">Ações</h3>
                <button id="clearFilters" class="button button-gray"><i class="fas fa-eraser"></i>Limpar Filtros</button>
                <button id="exportCsv" class="button button-blue" style="margin-top: 0.75rem;"><i class="fas fa-file-csv"></i>Exportar CSV</button>
                <button id="exportIssues" class="button button-red" style="margin-top: 0.75rem;"><i class="fas fa-triangle-exclamation"></i>Relatório de Falhas</button>
            </div>
        </div>
      </div>

      <div class="card">
        <table id="licenseTable" class="table-container display responsive" style="width:100%">
          <thead class="table-header">
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>Email</th>
              <th>Cargo</th>
              <th>Unidade</th>
              <th>Telefones</th>
              <th>Licenças</th>
            </tr>
            <tr> <th><input class="search-input" placeholder="ID..." /></th>
              <th><input class="search-input" placeholder="Nome..." /></th>
              <th><input class="search-input" placeholder="Email..." /></th>
              <th><input class="search-input" placeholder="Cargo..." /></th>
              <th><input class="search-input" placeholder="Unidade..." /></th>
              <th><input class="search-input" placeholder="Telefones..." /></th>
              <th><input class="search-input" placeholder="Licenças..." /></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>

<script>
  $(document).ready(function() {
    let table = null, allData = [], nameConflicts = new Set(), dupLicUsers = new Set();
    let uniqueLicenseNames = [];

    // Constante para o tempo de espera do debounce em milissegundos
    const DEBOUNCE_DELAY = 350;
    let multiSearchDebounceTimer;

    // Funções auxiliares
    const nameKey = u => `${u.DisplayName || ''}|||${u.OfficeLocation || ''}`;
    const escapeHtml = s => typeof s === 'string' ? s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&apos;' })[m]) : '';

    function validateJson(data) {
        if (!Array.isArray(data)) {
            alert('JSON inválido: Deve ser um array de objetos.');
            return [];
        }
        return data.map((u, i) => u && typeof u === 'object' ? {
            Id: u.Id || `unknown_${i}`,
            DisplayName: u.DisplayName || 'Desconhecido',
            OfficeLocation: u.OfficeLocation || 'Desconhecido',
            Email: u.Email || '',
            JobTitle: u.JobTitle || '',
            BusinessPhones: Array.isArray(u.BusinessPhones) ? u.BusinessPhones : [],
            Licenses: Array.isArray(u.Licenses) ? u.Licenses.map(l => ({
                LicenseName: l.LicenseName || `Lic_${i}_${Math.random().toString(36).substr(2, 5)}`,
                SkuId: l.SkuId || ''
            })) : []
        } : null).filter(x => x);
    }

    function findIssues(data) {
        const nameMap = new Map(), dupSet = new Set(), officeLic = new Set([
            'Microsoft 365 E3', 'Microsoft 365 E5',
            'Microsoft 365 Business Standard', 'Microsoft 365 Business Premium',
            'Office 365 E3', 'Office 365 E5'
        ]);
        data.forEach(u => {
            const k = nameKey(u);
            nameMap.set(k, (nameMap.get(k) || 0) + 1);
            const cnt = new Map();
            (u.Licenses || []).forEach(l => { // Adicionado fallback para u.Licenses
                const base = (l.LicenseName || '').match(/^(Microsoft 365|Office 365)/)?.[0] || l.LicenseName;
                cnt.set(base, (cnt.get(base) || 0) + 1);
            });
            if ([...cnt].some(([lic, c]) => officeLic.has(lic) && c > 1)) dupSet.add(u.Id);
        });
        return { nameConflicts: new Set([...nameMap].filter(([, c]) => c > 1).map(([k]) => k)), dupLicUsers: dupSet };
    }

    function renderAlerts() {
        const $p = $('#alertPanel').empty();
        if (nameConflicts.size) {
            $p.append(`<div class="alert-badge">
                <button id="filterNameConflicts" style="background: none; border: none; color: inherit; cursor: pointer; text-decoration: underline;" class="underline"><i class="fas fa-users-slash" style="margin-right: 0.3rem;"></i>Conflitos Nome+Unidade: ${nameConflicts.size}</button>
            </div>`);
        }
        if (dupLicUsers.size) {
            const list = allData.filter(u => dupLicUsers.has(u.Id)).map(u => {
                const cnt = {}, dups = [];
                (u.Licenses || []).forEach(l => cnt[l.LicenseName] = (cnt[l.LicenseName] || 0) + 1);
                Object.entries(cnt).forEach(([lic, c]) => c > 1 && dups.push(lic));
                const hasPaid = (u.Licenses || []).some(l => !(l.LicenseName || '').toLowerCase().includes('free'));
                return `<li>${escapeHtml(u.DisplayName)} (${escapeHtml(u.OfficeLocation)}): ${escapeHtml(dups.join(', '))} — Paga: ${hasPaid ? 'Sim' : 'Não'}</li>`;
            }).join('');
            $p.append(`<div class="alert-badge">
                <span><i class="fas fa-copy" style="margin-right: 0.3rem;"></i>Licenças duplicadas: ${dupLicUsers.size}</span>
                <button class="underline toggle-details" data-target="dupDetails" style="background: none; border: none; color: inherit; cursor: pointer; text-decoration: underline;">Detalhes</button>
            </div>
            <div id="dupDetails" class="alert-details"><ul>${list}</ul></div>`);
        }

        // Reanexar eventos
        $('#filterNameConflicts').off('click').on('click', function() {
            if (!table) return;
            const ids = allData.filter(u => nameConflicts.has(nameKey(u))).map(u => u.Id);
            table.search('').columns().search('').draw();
            table.column(0).search(ids.join('|'), true, false).draw();
        });
        $('.toggle-details').off('click').on('click', function() {
            const tgt = $(this).data('target');
            $(`#${tgt}`).toggleClass('show');
            $(this).text($(`#${tgt}`).hasClass('show') ? 'Ocultar' : 'Detalhes');
        });
    }

    function initTable(data) {
        allData = data;
        ({ nameConflicts, dupLicUsers } = findIssues(allData));

        const allLicenseObjects = allData.flatMap(user => user.Licenses || []).filter(l => l.LicenseName);
        uniqueLicenseNames = [...new Set(allLicenseObjects.map(l => l.LicenseName))].sort();

        if ($('#licenseDatalist').length === 0) {
            $('body').append('<datalist id="licenseDatalist"></datalist>');
        }
        const $licenseDatalist = $('#licenseDatalist').empty();
        uniqueLicenseNames.forEach(name => {
            $licenseDatalist.append($('<option>').attr('value', name));
        });

        if (table) table.destroy();

        table = $('#licenseTable').DataTable({
            data: allData,
            deferRender: true,
            pageLength: 25,
            orderCellsTop: true,
            // responsive: true, // Pode causar problemas de layout com a segunda linha de header para filtros
            // scrollX: true, // Adicionar se as colunas estourarem
            // Dentro da função initTable, na configuração do DataTable:
language: {
    "emptyTable": "Nenhum registro encontrado",
    "info": "Mostrando de _START_ até _END_ de _TOTAL_ registros",
    "infoEmpty": "Mostrando 0 até 0 de 0 registros",
    "infoFiltered": "(Filtrados de _MAX_ registros)",
    "infoThousands": ".",
    "lengthMenu": "_MENU_ resultados por página",
    "loadingRecords": "Carregando...",
    "processing": "Processando...",
    "zeroRecords": "Nenhum registro encontrado",
    "search": "Pesquisar:", // Adicionado ":" para consistência
    "paginate": {
        "next": "Próximo",
        "previous": "Anterior",
        "first": "Primeiro",
        "last": "Último"
    },
    "aria": {
        "sortAscending": ": Ordenar colunas de forma ascendente",
        "sortDescending": ": Ordenar colunas de forma descendente"
    },
    "select": {
        "rows": {
            "_": "Selecionado %d linhas",
            "0": "Nenhuma linha selecionada",
            "1": "Selecionado 1 linha"
        },
        "cells": {
            "1": "1 célula selecionada",
            "_": "%d células selecionadas"
        },
        "columns": {
            "1": "1 coluna selecionada",
            "_": "%d colunas selecionadas"
        }
    },
    "buttons": {
        "copySuccess": {
            "1": "Uma linha copiada para a área de transferência",
            "_": "%d linhas copiadas para a área de transferência"
        },
        "collection": "Coleção  <span class=\"ui-button-icon-primary ui-icon ui-icon-triangle-1-s\"><\/span>",
        "colvis": "Visibilidade da Coluna",
        "colvisRestore": "Restaurar Visibilidade",
        "copy": "Copiar",
        "copyKeys": "Pressione ctrl ou u2318 + C para copiar os dados da tabela para a área de transferência do sistema. Para cancelar, clique nesta mensagem ou pressione Esc..",
        "copyTitle": "Copiar para área de transferência",
        "csv": "CSV",
        "excel": "Excel",
        "pageLength": {
            "-1": "Mostrar todos os registros",
            "_": "Mostrar %d registros"
        },
        "pdf": "PDF",
        "print": "Imprimir",
        "createState": "Criar estado",
        "removeAllStates": "Remover todos os estados",
        "removeState": "Remover",
        "renameState": "Renomear",
        "savedStates": "Estados salvos",
        "stateRestore": "Estado %d",
        "updateState": "Atualizar"
    },
    "searchBuilder": {
        "add": "Adicionar Condição",
        "button": {
            "0": "Construtor de Pesquisa",
            "_": "Construtor de Pesquisa (%d)"
        },
        "clearAll": "Limpar Tudo",
        "condition": "Condição",
        "conditions": {
            "date": {
                "after": "Depois",
                "before": "Antes",
                "between": "Entre",
                "empty": "Vazio",
                "equals": "Igual",
                "not": "Não",
                "notBetween": "Não Entre",
                "notEmpty": "Não Vazio"
            },
            "number": {
                "between": "Entre",
                "empty": "Vazio",
                "equals": "Igual",
                "gt": "Maior Que",
                "gte": "Maior Ou Igual Que",
                "lt": "Menor Que",
                "lte": "Menor Ou Igual Que",
                "not": "Não",
                "notBetween": "Não Entre",
                "notEmpty": "Não Vazio"
            },
            "string": {
                "contains": "Contém",
                "empty": "Vazio",
                "endsWith": "Termina Com",
                "equals": "Igual",
                "not": "Não",
                "notEmpty": "Não Vazio",
                "startsWith": "Começa Com",
                "notContains": "Não contém",
                "notStartsWith": "Não começa com",
                "notEndsWith": "Não termina com"
            },
            "array": {
                "without": "Sem",
                "notEmpty": "Não Vazio",
                "not": "Não",
                "contains": "Contém",
                "empty": "Vazio",
                "equals": "Igual"
            }
        },
        "data": "Data",
        "deleteTitle": "Excluir regra de filtragem",
        "logicAnd": "E",
        "logicOr": "Ou",
        "title": {
            "0": "Construtor de Pesquisa",
            "_": "Construtor de Pesquisa (%d)"
        },
        "value": "Valor",
        "leftTitle": "Critérios Externos",
        "rightTitle": "Critérios Internos"
    },
    "searchPanes": {
        "clearMessage": "Limpar Tudo",
        "collapse": {
            "0": "Painéis de Pesquisa",
            "_": "Painéis de Pesquisa (%d)"
        },
        "count": "{total}",
        "countFiltered": "{shown} ({total})",
        "emptyPanes": "Nenhum Painel de Pesquisa",
        "loadMessage": "Carregando Painéis de Pesquisa...",
        "title": "Filtros Ativos",
        "showMessage": "Mostrar todos",
        "collapseMessage": "Fechar todos"
    },
    "thousands": ".",
    "datetime": {
        "previous": "Anterior",
        "next": "Próximo",
        "hours": "Hora",
        "minutes": "Minuto",
        "seconds": "Segundo",
        "unknown": "-",
        "amPm": [
            "am",
            "pm"
        ],
        "weekdays": [
            "Dom",
            "Seg",
            "Ter",
            "Qua",
            "Qui",
            "Sex",
            "Sáb"
        ],
        "months": [
            "Janeiro",
            "Fevereiro",
            "Março",
            "Abril",
            "Maio",
            "Junho",
            "Julho",
            "Agosto",
            "Setembro",
            "Outubro",
            "Novembro",
            "Dezembro"
        ]
    },
    "editor": {
        "close": "Fechar",
        "create": {
            "button": "Novo",
            "title": "Criar novo registro",
            "submit": "Criar"
        },
        "edit": {
            "button": "Editar",
            "title": "Editar registro",
            "submit": "Atualizar"
        },
        "remove": {
            "button": "Remover",
            "title": "Remover registro",
            "submit": "Remover",
            "confirm": {
                "_": "Deseja realmente remover %d registros?",
                "1": "Deseja realmente remover 1 registro?"
            }
        },
        "error": {
            "system": "Ocorreu um erro no sistema (<a target=\"\\\" rel=\"nofollow\" href=\"\\\">Mais informações<\/a>)."
        },
        "multi": {
            "title": "Múltiplos valores",
            "info": "Os itens selecionados contêm valores diferentes para esta entrada. Para editar e definir todos os itens para esta entrada com o mesmo valor, clique ou toque aqui, caso contrário, eles manterão seus valores individuais.",
            "restore": "Desfazer alterações",
            "noMulti": "Esta entrada pode ser editada individualmente, mas não como parte de um grupo."
        }
    },
    "stateRestore": {
        "creationModal": {
            "button": "Criar",
            "columns": {
                "search": "Busca de colunas",
                "visible": "Visibilidade da coluna"
            },
            "name": "Nome:",
            "order": "Ordernar",
            "paging": "Paginação",
            "scroller": "Posição da barra de rolagem",
            "search": "Busca",
            "searchBuilder": "Construtor de pesquisa",
            "select": "Selecionar",
            "title": "Criar novo estado",
            "toggleLabel": "Inclui:"
        },
        "duplicateError": "Já existe um estado com este nome.",
        "emptyError": "Não pode ser vazio.",
        "emptyStates": "Nenhum estado salvo",
        "removeConfirm": "Confirma remover %s?",
        "removeError": "Falha ao remover estado.",
        "removeJoiner": "e",
        "removeSubmit": "Remover",
        "removeTitle": "Remover estado",
        "renameButton": "Renomear",
        "renameLabel": "Novo nome para %s:",
        "renameTitle": "Renomear estado"
    },
    "decimal": "," // Adicionando a vírgula como separador decimal
},
            columnDefs: [
                { targets: '_all', visible: false },
                { targets: [1, 2, 3, 6], visible: true }
            ],
            columns: [
                { data: 'Id', title: 'ID' }, // Adicionar 'title' para referência mais fácil
                { data: 'DisplayName', title: 'Nome' },
                { data: 'Email', title: 'Email' },
                { data: 'JobTitle', title: 'Cargo' },
                { data: 'OfficeLocation', title: 'Unidade' },
                { data: 'BusinessPhones', title: 'Telefones', render: p => Array.isArray(p) ? p.join('; ') : (p || '') },
                { data: 'Licenses', title: 'Licenças', render: l => Array.isArray(l) ? l.map(x => x.LicenseName || '').join(', ') : '' }
            ],
            initComplete: function() {
                const api = this.api();
                // Ajuste para pegar os inputs na segunda linha do thead
                api.columns().every(function(colIdx) {
                    const column = this;
                    // O cabeçalho da coluna tem o título, a segunda linha do thead tem os inputs
                    const input = $(api.table().header()).find('tr:eq(1) th:eq(' + colIdx + ') input');
                    if (input.length > 0) {
                        input.off('keyup change clear').on('keyup change clear', function() {
                            if (column.search() !== this.value) {
                                column.search(this.value).draw();
                            }
                        });
                    }
                });

                $('#colContainer .col-vis').each(function() {
                    const idx = +$(this).data('col');
                    try { // Adiciona try-catch para coluna inexistente
                        $(this).prop('checked', api.column(idx).visible());
                    } catch (e) {
                        console.warn("Erro ao verificar visibilidade da coluna:", idx, e);
                    }
                });
                $('.col-vis').off('change').on('change', function() {
                    const idx = +$(this).data('col');
                    try {
                        const col = api.column(idx);
                        col.visible(!col.visible());
                    } catch (e) {
                        console.warn("Erro ao alternar visibilidade da coluna:", idx, e);
                    }
                });
                $('#multiSearchFields .multi-search-row').each(function() {
                    updateLicenseInputState($(this));
                });
            },
            rowCallback: function(row, data) {
                $(row).removeClass('conflict dup-license'); // Limpa classes
                if (nameConflicts.has(nameKey(data))) $(row).addClass('conflict');
                if (dupLicUsers.has(data.Id)) $(row).addClass('dup-license');
            },
            drawCallback: renderAlerts
        });
    }

    function updateLicenseInputState($row) {
        const $select = $row.find('.column-select');
        const $input = $row.find('.search-input').not('.column-select'); // Pega o input de termo
        if ($select.val() == 6) { // Coluna de Licenças
            $input.attr('list', 'licenseDatalist');
            $input.attr('placeholder', 'Selecione ou digite licença...');
        } else {
            $input.removeAttr('list');
            $input.attr('placeholder', 'Termo...');
        }
    }

    function setupMultiSearch() {
        const cols = [
            { v: 0, text: 'ID' }, { v: 1, text: 'Nome' }, { v: 2, text: 'Email' },
            { v: 3, text: 'Cargo' }, { v: 4, text: 'Unidade' }, { v: 5, text: 'Telefones' },
            { v: 6, text: 'Licenças' }
        ];
        const $ct = $('#multiSearchFields'); // Não esvaziar aqui, para persistir filtros
        
        function addSearchField() {
            const $r = $(`<div class="multi-search-row">
                <select class="column-select">
                    ${cols.map(c => `<option value="${c.v}">${c.text}</option>`).join('')}
                </select>
                <input class="search-input" placeholder="Termo..." />
                <button class="remove-field" title="Remover filtro"><i class="fas fa-trash-alt"></i></button>
            </div>`);
            $ct.append($r);
            updateLicenseInputState($r);
            $r.find('.search-input, .column-select').on('input change', applyMultiSearch);
            $r.find('.remove-field').on('click', function() {
                $(this).closest('.multi-search-row').remove();
                applyMultiSearch();
            });
        }

        $('#addSearchField').off('click').on('click', addSearchField);
        $('#multiSearchOperator').off('change').on('change', applyMultiSearch);

        if ($ct.children().length === 0) { // Adiciona um campo inicial apenas se não houver nenhum
            addSearchField();
        }
        _executeMultiSearchLogic(); // Aplica filtros existentes ou estado limpo
    }

    function _executeMultiSearchLogic() {
        const op = $('#multiSearchOperator').val();
        const $searchCriteria = $('#searchCriteria');
        
        if (!table && allData.length === 0) {
            $searchCriteria.text('Nenhum critério aplicado. Carregue um arquivo JSON.');
            return;
        }
        if (!table && allData.length > 0) {
            $searchCriteria.text('Tabela não inicializada, mas dados carregados. Filtros serão aplicados ao carregar a tabela.');
            return;
        }
         if (!table) { // Segurança adicional
            $searchCriteria.text('Tabela não disponível.');
            return;
        }


        $searchCriteria.text(op === 'AND' ?
            'Critério: Afunilando resultados (todos os filtros devem corresponder)' :
            'Critério: Expandindo resultados (qualquer filtro corresponde)');

        table.search('').columns().search(''); // Limpa filtros nativos
        const rows = $('#multiSearchFields .multi-search-row');
        const filters = [];
        rows.each(function() {
            const idx = $(this).find('.column-select').val();
            const val = $(this).find('.search-input').not('.column-select').val().trim();
            if (val) {
                filters.push({ col: parseInt(idx, 10), term: val });
            }
        });

        // Limpa filtros customizados anteriores do DataTables
        while ($.fn.dataTable.ext.search.length > 0) {
            $.fn.dataTable.ext.search.pop();
        }

        if (filters.length > 0) {
            $searchCriteria.append(` (${filters.length} filtro(s) ativo(s))`);
            $.fn.dataTable.ext.search.push(
                function(settings, data, dataIndex) {
                    if (settings.nTable.id !== table.table().node().id) return true;
                    const rowData = table.row(dataIndex).data();
                    if (!rowData) return false; 

                    if (op === 'OR') {
                        return filters.some(filter => {
                            if (filter.col === 6) { // Licenças
                                return (rowData.Licenses && Array.isArray(rowData.Licenses)) ?
                                    rowData.Licenses.map(l => l.LicenseName || '').join(', ').toLowerCase().includes(filter.term.toLowerCase()) : false;
                            }
                            const cellValue = data[filter.col] || '';
                            return cellValue.toString().toLowerCase().includes(filter.term.toLowerCase());
                        });
                    } else { // AND
                        return filters.every(filter => {
                            if (filter.col === 6) { // Licenças
                                return (rowData.Licenses && Array.isArray(rowData.Licenses)) ?
                                    rowData.Licenses.map(l => l.LicenseName || '').join(', ').toLowerCase().includes(filter.term.toLowerCase()) : false;
                            }
                            const cellValue = data[filter.col] || '';
                            return cellValue.toString().toLowerCase().includes(filter.term.toLowerCase());
                        });
                    }
                }
            );
        } else {
            $searchCriteria.text(op === 'AND' ? 'Critério: Todos os resultados (nenhum filtro AND ativo)' : 'Critério: Todos os resultados (nenhum filtro OR ativo)');
        }
        table.draw();
        // Remove o filtro customizado após o draw para não interferir em outras operações
        if (filters.length > 0 && $.fn.dataTable.ext.search.length > 0) {
            $.fn.dataTable.ext.search.pop();
        }
    }

    function applyMultiSearch() {
        clearTimeout(multiSearchDebounceTimer);
        multiSearchDebounceTimer = setTimeout(_executeMultiSearchLogic, DEBOUNCE_DELAY);
    }

    // Manipuladores de evento para botões principais
    $('#clearFilters').on('click', () => {
        if (table) {
            $(table.table().header()).find('tr:eq(1) th input').val(''); // Limpa inputs da 2a linha do header
            table.search('').columns().search('').draw();
        }
        $('#multiSearchFields').empty(); // Limpa os campos de filtro da pesquisa múltipla
        if (allData.length > 0) { // Só reconfigura multi-search se houver dados
             setupMultiSearch(); // Adiciona um campo de filtro padrão
        } else {
             $('#searchCriteria').text('Nenhum critério aplicado. Carregue um arquivo JSON.');
        }
        $('#alertPanel').empty();
        $('#colContainer .col-vis').each(function() {
            const idx = +$(this).data('col');
            const isDefaultVisible = [1, 2, 3, 6].includes(idx);
            if (table) {
                try { table.column(idx).visible(isDefaultVisible); } catch(e){}
            }
            $(this).prop('checked', isDefaultVisible);
        });
        // _executeMultiSearchLogic(); // Chama para atualizar o texto e redesenhar se necessário
    });

    function escapeCsvValue(value) {
        if (value == null) return ''; // Trata nulos e undefined como string vazia
        let stringValue = String(value);
        // Se contiver vírgula, aspas ou quebra de linha, coloca entre aspas e duplica as aspas internas
        if (/[,"\n\r]/.test(stringValue)) {
            stringValue = `"${stringValue.replace(/"/g, '""')}"`;
        }
        return stringValue;
    }

    function downloadCsv(csvContent, fileName) {
        const bom = "\uFEFF"; // BOM para UTF-8
        const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) { // Feature detection
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    }

    $('#exportCsv').on('click', () => {
        if (!table) return alert('Tabela não iniciada. Carregue um arquivo JSON.');
        
        const rowsToExport = table.rows({ search: 'applied' }).data().toArray();
        if (!rowsToExport.length) return alert('Nenhum registro para exportar com os filtros atuais.');

        const visibleColumns = [];
        table.columns(':visible').every(function() {
            const headerCell = $(this.header());
            // Pega o título da primeira linha do thead para esta coluna
            const columnTitle = $(table.table().header()).find('tr:eq(0) th:eq(' + this.index() + ')').text();
            visibleColumns.push({
                title: columnTitle,
                dataProp: table.settings()[0].aoColumns[this.index()].mData // Nome da propriedade dos dados
            });
        });

        const headerRow = visibleColumns.map(col => escapeCsvValue(col.title)).join(',');
        const csvRows = rowsToExport.map(rowData => {
            return visibleColumns.map(col => {
                let cellData = rowData[col.dataProp];
                 // Renderização especial para colunas específicas, se necessário
                if (col.dataProp === 'BusinessPhones') {
                    cellData = Array.isArray(cellData) ? cellData.join('; ') : (cellData || '');
                } else if (col.dataProp === 'Licenses') {
                    cellData = (Array.isArray(rowData.Licenses) && rowData.Licenses.length > 0) ? 
                               rowData.Licenses.map(l => l.LicenseName || '').join('; ') : '';
                }
                return escapeCsvValue(cellData);
            }).join(',');
        });

        const csvContent = [headerRow, ...csvRows].join('\n');
        downloadCsv(csvContent, 'relatorio_licencas.csv');
    });

    $('#exportIssues').on('click', () => {
        if (!allData.length) return alert('Nenhum dado carregado para gerar relatório de falhas.');
        let lines = [];
        if (nameConflicts.size) {
            lines.push(['CONFLITOS Nome+Unidade'], ['Nome', 'Unidade']);
            nameConflicts.forEach(k => lines.push(k.split('|||').map(escapeCsvValue)));
            lines.push([]); // Linha vazia como separador
        }
        if (dupLicUsers.size) {
            lines.push(['USUÁRIOS com Licenças Duplicadas'], ['Nome', 'Unidade', 'Licenças Duplicadas', 'Possui Licença Paga?']);
            allData.filter(u => dupLicUsers.has(u.Id)).forEach(u => {
                const cnt = {}, dups = [];
                (u.Licenses || []).forEach(l => cnt[l.LicenseName] = (cnt[l.LicenseName] || 0) + 1);
                Object.entries(cnt).forEach(([l, c]) => c > 1 && dups.push(l));
                const hasPaid = (u.Licenses || []).some(l => !(l.LicenseName || '').toLowerCase().includes('free'));
                lines.push([u.DisplayName, u.OfficeLocation, dups.join('; '), hasPaid ? 'Sim' : 'Não'].map(escapeCsvValue));
            });
        }
        if (!lines.length) return alert('Nenhuma falha detectada.');
        downloadCsv(lines.map(r => r.join(',')).join('\n'), 'relatorio_falhas.csv');
    });

    // Carregamento do JSON
    $('#jsonFile').on('change', e => {
        const f = e.target.files[0];
        if (!f) return;
        const fr = new FileReader();
        fr.onload = () => {
            try {
                const d = JSON.parse(fr.result);
                const v = validateJson(d);
                if (!v.length) {
                    alert('Nenhum usuário válido encontrado no JSON.');
                    if (table) {
                        table.clear().destroy();
                        table = null;
                    }
                    allData = [];
                    nameConflicts.clear();
                    dupLicUsers.clear();
                    uniqueLicenseNames = [];
                    $('#multiSearchFields').empty(); // Limpa filtros múltiplos
                    $('#alertPanel').empty();
                    $('#searchCriteria').text('Nenhum critério aplicado. Carregue um arquivo JSON.');
                    return;
                }
                initTable(v);
                setupMultiSearch(); // Configura a pesquisa múltipla após carregar dados
            } catch (er) {
                alert('Erro ao processar JSON: ' + er.message);
                console.error("Erro JSON:", er);
            }
        };
        fr.readAsText(f);
    });

    // Estado inicial
    $('#searchCriteria').text('Nenhum critério aplicado. Carregue um arquivo JSON.');
    if (allData.length === 0 && !table) {
        // Não chama setupMultiSearch aqui para evitar adicionar campos de filtro antes dos dados
        // Apenas garante que a mensagem inicial seja mostrada
    }
});
</script>
</body>
</html>
